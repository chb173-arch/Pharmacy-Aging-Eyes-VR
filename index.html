 <!--Run in project directory for localhost:8000 ... [python -m http.server]--> 
 <!--SAVE AS and RENAME this template "index.html"-->
 <!--project directory should have index.html and "assets" folder-->

<!DOCTYPE html>
<html>
<head>
  <title>Aging Sensitivity</title>
  <meta name="description" content="Aging-related eye disorders">
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>

  <script>
    AFRAME.registerComponent('play-on-click', {
      init: function () {
        const sceneEl = this.el.sceneEl;
        sceneEl.addEventListener('loaded', () => {
          console.log("Scene loaded, waiting for user click...");
          window.addEventListener('click', () => {
            const vids = document.querySelectorAll('video');
            vids.forEach((v) => {
              if (v.paused) {
                v.play()
                  .then(() => console.log(`${v.id} is playing`))
                  .catch((e) => console.warn(`${v.id} play failed:`, e));
              }
            });
          }, { once: true });
        });
      }
    });
  </script>

<script>
  // 1. MACULAR DEGENERATION (Central Irregular Blob)
  AFRAME.registerShader('macular-shader', {
    schema: { time: {type: 'time', is: 'uniform'}, opacity: {type: 'number', is: 'uniform', default: 0.0} },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
    fragmentShader: `
      varying vec2 vUv; uniform float time; uniform float opacity;
      float rand(vec2 co){ return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453); }
      void main() {
        if (opacity < 0.01) discard;
        vec2 p = vUv - vec2(0.5);
        float angle = atan(p.y, p.x);
        float radius = length(p);
        float warp = sin(angle * 3.0) * 0.005 + sin(angle * 7.0 + 1.5) * 0.003 + sin(angle * 12.0) * 0.002;
        float blobRadius = 0.025 + warp; 
        float alpha = 1.0 - smoothstep(blobRadius, blobRadius + 0.035, radius);
        float noise = rand(vUv * 100.0) * 0.15; 
        gl_FragColor = vec4(0.0, 0.0, 0.0, (alpha + (noise * alpha)) * opacity);
      }
    `
  });

  // 2. CATARACTS (Milky Haze)
  AFRAME.registerShader('cataract-shader', {
    schema: { opacity: {type: 'number', is: 'uniform', default: 0.0} },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
    fragmentShader: `
      uniform float opacity;
      void main() {
        if (opacity < 0.01) discard;
        gl_FragColor = vec4(1.0, 0.98, 0.9, opacity); 
      }
    `
  });

  // 3. GLAUCOMA (Tunnel Vision)
  AFRAME.registerShader('glaucoma-shader', {
    schema: { opacity: {type: 'number', is: 'uniform', default: 0.0} },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
    fragmentShader: `
      varying vec2 vUv; uniform float opacity;
      void main() {
        if (opacity < 0.01) discard;
        float dist = distance(vUv, vec2(0.5));
        // Create the tunnel: Clear until 0.15, then fade to black by 0.35
        float vignette = smoothstep(0.15, 0.35, dist);
        gl_FragColor = vec4(0.0, 0.0, 0.0, vignette * opacity);
      }
    `
  });

  // 4. DIABETIC RETINOPATHY (Random Floaters/Spots)
  AFRAME.registerShader('retinopathy-shader', {
    schema: { opacity: {type: 'number', is: 'uniform', default: 0.0} },
    vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
    fragmentShader: `
      varying vec2 vUv; uniform float opacity;
      float random(vec2 st) {
          return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
      }
      void main() {
        if (opacity < 0.01) discard;
        vec2 grid = vUv * 30.0; 
        vec2 ipos = floor(grid);
        float noise = random(ipos);
        float spots = step(0.92, noise);
        gl_FragColor = vec4(0.1, 0.0, 0.0, spots * opacity);
      }
    `
  });
</script>


</head>

<body>
  <a-scene physics="driver: local" shadow="type: pcfsoft" play-on-click>
    <a-assets>
      <video id="360video1" src="assets/ForbesAveCrosswalk360.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="360video2" src="assets/FromSalkAnnex360.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="360video3" src="assets/RecCenterSalk360.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="360video4" src="assets/ScaifeInterior360.mp4" loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>

    </a-assets>

    <a-videosphere src="#360video1"></a-videosphere>

    <a-entity id="playerRig" position="0 0 0" kinematic-body="radius: 0.5" wasd-controls>
      <a-camera id="playerCamera" position="0 2 0" look-controls>
        <a-cursor raycaster="objects: [data-clickable]"></a-cursor>

        <a-entity id="filter-macular" geometry="primitive: plane; height: 2; width: 2" position="0 0 -0.2"
          material="shader: macular-shader; transparent: true; depthTest: false; opacity: 0.0"></a-entity>

        <a-entity id="filter-cataract" geometry="primitive: plane; height: 2; width: 2" position="0 0 -0.2"
          material="shader: cataract-shader; transparent: true; depthTest: false; opacity: 0.0"></a-entity>
          
        <a-entity id="filter-glaucoma" geometry="primitive: plane; height: 2; width: 2" position="0 0 -0.2"
          material="shader: glaucoma-shader; transparent: true; depthTest: false; opacity: 0.0"></a-entity>

        <a-entity id="filter-retinopathy" geometry="primitive: plane; height: 2; width: 2" position="0 0 -0.2"
          material="shader: retinopathy-shader; transparent: true; depthTest: false; opacity: 0.0"></a-entity>
      </a-camera>
    </a-entity>

    <a-plane position="0 0 0" rotation="-90 0 0" width="100" height="100" color="#7BC8A4" shadow="receive: true" static-body opacity="0"></a-plane>
    <a-light type="ambient" color="#888"></a-light>
    <a-light type="directional" position="-1 1 0.5" intensity="0.6" shadow="cast: true"></a-light>

  </a-scene>

<div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 999; display: flex; gap: 10px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 10px;">
  
  <button onclick="toggleFilter('none')" style="padding: 8px 15px; cursor: pointer;">Normal</button>
  <button onclick="toggleFilter('macular')" style="padding: 8px 15px; cursor: pointer;">Macular</button>
  <button onclick="toggleFilter('cataract')" style="padding: 8px 15px; cursor: pointer;">Cataracts</button>
  <button onclick="toggleFilter('glaucoma')" style="padding: 8px 15px; cursor: pointer;">Glaucoma</button>
  <button onclick="toggleFilter('retinopathy')" style="padding: 8px 15px; cursor: pointer;">Retinopathy</button>

</div>

<script>
  function toggleFilter(type) {
    // 1. List all filter IDs
    const filters = ['macular', 'cataract', 'glaucoma', 'retinopathy'];

    // 2. Turn EVERY filter OFF first
    filters.forEach(f => {
      document.querySelector('#filter-' + f).setAttribute('material', 'opacity', 0.0);
    });

    // 3. Turn ON the one we clicked (if it's not 'none')
    if (type !== 'none') {
      const activeFilter = document.querySelector('#filter-' + type);
      
      // Set specific intensities for each disease for best effect
      if (type === 'macular') activeFilter.setAttribute('material', 'opacity', 1.0);
      if (type === 'cataract') activeFilter.setAttribute('material', 'opacity', 0.9);
      if (type === 'glaucoma') activeFilter.setAttribute('material', 'opacity', 1.0);
      if (type === 'retinopathy') activeFilter.setAttribute('material', 'opacity', 1.0);
    }
    
    console.log("Switched filter to:", type);
  }
</script>

</body>
</html>